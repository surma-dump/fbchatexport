<!doctype html>
<html>
<head>
  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
    }
    div {
      margin: 10px 0;
    }
    select {
      display: block;
      width: 100%;
      min-height: 50vh;
    }
    .step {
      border-left: 3px solid transparent;
      padding: 10px;
      background-color: rgba(0,0,0,0.5);
    }
    .step.current {
      border-left-color: #0f0;
      background-color: transparent;
    }
  </style>
</head>
<body>
    <script src="bower_components/stringview/stringview.js"></script>
    <script src="bower_components/jszip/dist/jszip.min.js"></script>
    <script src="https://google.github.io/traceur-compiler/bin/traceur.js"></script>
    <script src="https://google.github.io/traceur-compiler/src/bootstrap.js"></script>
  <div id="step1" class="step current">
  	App ID: <input id="appid" value="1514696795484893">
  	<button id="listConvs">List Conversations</button>
  </div>
  <div id="step2" class="step">
    <select id="convSelect" multiple></select>
    Options:
    <input type="checkbox" id="loadAttachments"><label for="loadAttachments">Load Attachments</label>
    <input type="checkbox" id="loadAvatars"><label for="loadAvatars">Load Avatars</label>
  	<button id="loadConvs">Download selected conversations</button>
  </div>
	<div id="status"></div>
	<div id="result"></div>
	<script>
		(function(d, s, id){
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) {return;}
			js = d.createElement(s); js.id = id;
			js.src = "//connect.facebook.net/en_US/sdk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>
	<script type="module" src="facebook.js"></script>
	<script type="module">
    var appId = '1514696795484893';
	  import * as facebook from 'facebook.js';

    var currentStep = 1;
    function nextStep() {
      document.querySelector(`#step${currentStep}`).className = "step";
      currentStep++;
      document.querySelector(`#step${currentStep}`).className = "step current";
    }

    function setStatus(msg, data) {
      var elem = document.querySelector('#status');
      elem.textContent = msg;
      if(this == true) {
        elem.textContent = elem.textContent + JSON.stringify(data);
      }
      return data;
    }

    var convSelect = document.querySelector("#convSelect");

	  document.querySelector('#listConvs').onclick = function() {
  	  facebook.login(document.querySelector('#appid').value)
	    .then(setStatus.bind(false, 'Loading list of conversations'))
  	  .then(facebook.listConversations)
      .then(convList => convList.forEach(item => {
        var o = convSelect.appendChild(document.createElement('option'));
        o.setAttribute('value', JSON.stringify(item));
        o.textContent = item.participants.data.reduce((p, c) => `${p}${p!=''?', ':''}${c.name}`, '') + ` (${item.message_count} messages)`;
      }))
      .then(nextStep)
	    .then(setStatus.bind(false, 'Done'))
  	};

    document.querySelector('#loadConvs').onclick = function() {
      var p = Promise.resolve(Array.prototype.map.call(convSelect.selectedOptions, i => JSON.parse(i.value)))
	    .then(setStatus.bind(false, 'Loading conversations'))
  	  .then(convList => Promise.all(convList.map(facebook.loadConversation)));

      if(document.querySelector('#loadAttachments').checked) {
        p = p.then(setStatus.bind(false, 'Loading attachments'))
        .then(convList => Promise.all(convList.map(facebook.loadAttachments)));
      }
      p.then(setStatus.bind(false, 'Serializing conversations'))
  	  .then(convList => Promise.all(convList.map(facebook.stringifyConversation)))
      .then(setStatus.bind(false, 'Zipping conversations'))
  	  .then(convList => {
  	    var zip = new JSZip();
  	    convList.forEach(conv => zip.file(`${conv.name}.json`, conv.data));
  	    return Promise.resolve(zip.generate({type: 'blob'}));
  	  })
  	  .then(archive => {
  	    location.href = URL.createObjectURL(archive);
  	  })
      .then(setStatus.bind(false, 'Done'))
  	  .catch(setStatus.bind(true, 'Something went wrong!'));
    };
	</script>
</body>
</html>
